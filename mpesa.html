<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pay with M-Pesa - LEE GLOBAL HOLDINGS</title>
    <link rel="icon" type="image/jpeg" href="images/21355.jpg">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="application-name" content="LEE GLOBAL">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="LEE GLOBAL">
    <link rel="apple-touch-icon" href="images/21355.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white min-h-screen">
    <div class="max-w-3xl mx-auto p-8">
        <h1 class="text-3xl font-bold text-orange-50 mb-4">Pay with M-Pesa</h1>
        <p class="mb-4 text-orange-100/80">Send funds directly using M-Pesa to the following number. After you send, please keep the transaction receipt/reference and contact us with the reference so we can allocate your tokens.</p>

        <div class="p-6 bg-stone-900/50 rounded-lg border border-orange-900/20 mb-6">
            <div class="text-sm text-orange-100/70 mb-2">M-Pesa Number</div>
            <div class="flex items-center space-x-4">
                <div class="text-2xl font-mono text-orange-300">0708623801</div>
                <button id="copy-btn" class="px-3 py-2 bg-orange-600 rounded text-black">Copy</button>
                <a id="call-btn" href="tel:+254708623801" class="px-3 py-2 bg-green-600 rounded text-white">Call / Open M-Pesa</a>
            </div>
            <p class="mt-3 text-sm text-orange-100/60">If your device supports tel: links, "Call / Open M-Pesa" will open your phone dialer or M-Pesa app. Otherwise, copy the number and paste it into your M-Pesa app or USSD prompt to send the payment. (Assuming Kenyan number: +254 708 623801)</p>
        </div>

        <div id="amount-block" class="p-6 bg-stone-900/50 rounded-lg border border-orange-900/20 mb-6 hidden">
            <div class="text-sm text-orange-100/70 mb-2">Amount</div>
            <div class="text-xl text-orange-300 mb-2">USD: <span id="usd-amount">0.00</span></div>
            <div class="text-xl text-orange-300">LΞΞ: <span id="lee-amount">0</span></div>
            <p class="mt-3 text-sm text-orange-100/60">Send the exact amount and include a clear reference so we can match your payment.</p>
        </div>

        <div class="mb-6 p-6 bg-stone-900/50 rounded-lg border border-orange-900/20">
            <h2 class="text-lg text-orange-50 mb-3">Step-by-step: How to pay (recommended)</h2>
            <ol class="list-decimal list-inside space-y-2 text-orange-100/80 text-sm">
                <li>
                    Open your M-Pesa app on your phone. If you don't have the app, open your mobile network's M-Pesa/USSD menu.
                </li>
                <li>
                    Choose "Send Money" (or the equivalent option). Some phones/apps show "Lipa na M-Pesa" → "Paybill"/"Buy Goods" or "Send Money" — choose send money to a mobile number.
                </li>
                <li>
                    Enter the recipient number: <strong>0708623801</strong> (or paste if you copied it from this page).
                </li>
                <li>
                    Enter the exact amount in KES or USD depending on your provider. (This site uses USD amounts; convert as needed.)
                </li>
                <li>
                    In the reference/narration field, include a clear transaction reference so we can match the payment (suggested format shown below).
                </li>
                <li>
                    Enter your M-Pesa PIN and confirm the transaction. Keep the transaction code/receipt shown after payment.
                </li>
                <li>
                    Return to this page and submit the confirmation form with the transaction reference (and optional screenshot) so we can verify and allocate tokens.
                </li>
            </ol>

            <div class="mt-4 text-sm text-orange-100/70">
                Suggested reference format (helps verification): <code id="suggested-ref" class="bg-black/30 px-2 py-1 rounded">LEE-YYYYMMDD-HHMM-NAME</code>
                <div class="mt-2">Example: <span class="text-orange-300">LEE-20251105-1530-JOHNDOE</span></div>
            </div>
        </div>

        <div class="mt-6">
            <a href="index.html" class="inline-block px-4 py-2 bg-stone-800/50 rounded border border-orange-900/20">Back</a>
            <button id="done-btn" class="ml-3 px-4 py-2 bg-orange-600 text-black rounded">I have paid</button>
        </div>

        <div class="mt-8 p-6 bg-stone-900/50 rounded-lg border border-orange-900/20">
            <h2 class="text-xl text-orange-50 mb-3">Submit Payment Confirmation</h2>
            <form id="payment-form" class="space-y-4">
                <div>
                    <label class="block text-sm text-orange-100/70">Full name</label>
                    <input id="name" required class="w-full mt-1 p-2 bg-black/20 border border-orange-900/20 rounded" placeholder="Your full name">
                </div>
                <div>
                    <label class="block text-sm text-orange-100/70">Email (we will send your dashboard link here)</label>
                    <input id="email" type="email" required class="w-full mt-1 p-2 bg-black/20 border border-orange-900/20 rounded" placeholder="you@example.com">
                </div>
                <div>
                    <label class="block text-sm text-orange-100/70">Phone (used to send M-Pesa)</label>
                    <input id="phone" class="w-full mt-1 p-2 bg-black/20 border border-orange-900/20 rounded" placeholder="e.g. 0708XXXXXX">
                </div>
                <div>
                    <label class="block text-sm text-orange-100/70">Amount (USD)</label>
                    <input id="form-amount" type="number" step="0.01" required class="w-full mt-1 p-2 bg-black/20 border border-orange-900/20 rounded">
                </div>
                <div>
                    <label class="block text-sm text-orange-100/70">Transaction reference</label>
                    <input id="tx-ref" required class="w-full mt-1 p-2 bg-black/20 border border-orange-900/20 rounded" placeholder="M-Pesa transaction code / reference">
                </div>
                <div>
                    <label class="block text-sm text-orange-100/70">Optional: Upload screenshot (jpg/png)</label>
                    <input id="screenshot" type="file" accept="image/*" class="mt-1 text-sm">
                </div>

                <div>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Submit confirmation</button>
                </div>
            </form>

            <div id="submission-result" class="mt-4 hidden p-4 bg-black/20 rounded border border-green-700">
                <div id="submission-message" class="text-sm text-green-200"></div>
            </div>
        </div>

        <p class="mt-6 text-sm text-orange-100/60">After submission, your confirmation will show an ID and status "Pending verification". We will verify and allocate your Lee Coin after manual review.</p>
    </div>

    <script>
        // Assumption: number is Kenyan. If this is not correct, update the tel: link accordingly.
        const params = new URLSearchParams(window.location.search);
        const amount = params.get('amount');
        if (amount && parseFloat(amount) > 0) {
            document.getElementById('amount-block').classList.remove('hidden');
            document.getElementById('usd-amount').textContent = parseFloat(amount).toFixed(2);
            // 1 USD = 1 LΞΞ
            document.getElementById('lee-amount').textContent = parseFloat(amount).toFixed(2);
            // prefill form amount if form exists
            const formAmount = document.getElementById('form-amount');
            if (formAmount) formAmount.value = parseFloat(amount).toFixed(2);
        }

        document.getElementById('copy-btn').addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText('0708623801');
                document.getElementById('copy-btn').textContent = 'Copied';
                setTimeout(() => document.getElementById('copy-btn').textContent = 'Copy', 2000);
            } catch (err) {
                alert('Copy failed. Please copy the number manually: 0708623801');
            }
        });

        // Scroll to form when user clicks "I have paid" and prefill a suggested reference
        document.getElementById('done-btn').addEventListener('click', (e) => {
            e.preventDefault();
            const form = document.getElementById('payment-form');
            if (form) {
                // generate a suggested reference: LEE-YYYYMMDD-HHMM-<shortid>
                const now = new Date();
                const pad = n => n.toString().padStart(2, '0');
                const y = now.getFullYear();
                const m = pad(now.getMonth() + 1);
                const d = pad(now.getDate());
                const hh = pad(now.getHours());
                const mm = pad(now.getMinutes());
                const suggested = `LEE-${y}${m}${d}-${hh}${mm}`;
                const suggestedEl = document.getElementById('suggested-ref');
                if (suggestedEl) suggestedEl.textContent = suggested + '-NAME';

                const txInput = document.getElementById('tx-ref');
                if (txInput && !txInput.value) {
                    txInput.value = suggested;
                }

                form.scrollIntoView({ behavior: 'smooth', block: 'center' });
                const nameInput = document.getElementById('name');
                if (nameInput) nameInput.focus();
            }
        });

        // Form submission: store to localStorage and show confirmation
        const form = document.getElementById('payment-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const usd = document.getElementById('form-amount').value;
            const txRef = document.getElementById('tx-ref').value.trim();

            // handle optional screenshot
            const fileInput = document.getElementById('screenshot');
            let screenshotData = null;
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                // limit ~2.5MB
                if (file.size > 2.5 * 1024 * 1024) {
                    alert('Screenshot too large. Please use an image smaller than 2.5MB.');
                    return;
                }
                screenshotData = await fileToDataUrl(file);
            }

            // POST to server
            try {
                const resp = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, phone, email: document.getElementById('email').value.trim(), usd: Number(usd), lee: Number(usd), txRef, screenshot: screenshotData })
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Submission failed');

                const id = data.id;
                const result = document.getElementById('submission-result');
                const msg = document.getElementById('submission-message');
                msg.innerHTML = `Thank you, <strong>${escapeHtml(name)}</strong> — your submission ID is <strong>${id}</strong>.<br/>Status: <strong>Pending verification</strong>.<br/>We will contact you after manual confirmation.`;
                result.classList.remove('hidden');
                // reset parts of form
                document.getElementById('tx-ref').value = '';
                document.getElementById('screenshot').value = '';
                result.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (err) {
                alert('Submission failed: ' + err.message);
            }
        });

        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function escapeHtml(unsafe) {
            return unsafe.replace(/[&<"'`=\/]/g, function (s) {
                return ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;',
                    '/': '&#x2F;',
                    '`': '&#x60;',
                    '=': '&#x3D;'
                })[s];
            });
        }
    </script>
</body>
</html>
